<!DOCTYPE html>
<html class="writer-html5" lang="fr" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Installation et gestion de l’extension PostgreSQL PlumePg &mdash; Documentation Plume 0.3.0-beta</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/translations.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Recherche" href="../search.html" />
    <link rel="next" title="Métadonnées communes" href="metadonnees_communes.html" />
    <link rel="prev" title="Paramètres utilisateurs" href="parametres_utilisateur.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../index.html" class="icon icon-home"> Plume
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Rechercher docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="usage.html">Usage</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="generation_dictionnaire_widgets.html">Génération du dictionnaire des widgets</a></li>
<li class="toctree-l2"><a class="reference internal" href="creation_widgets.html">Création d’un nouveau widget</a></li>
<li class="toctree-l2"><a class="reference internal" href="actions_widgets.html">Actions contrôlées par les widgets du formulaire</a></li>
<li class="toctree-l2"><a class="reference internal" href="outils_saisie_geometries.html">Outils d’aide à la saisie des géométries</a></li>
<li class="toctree-l2"><a class="reference internal" href="metadonnees_calculees.html">Métadonnées calculées</a></li>
<li class="toctree-l2"><a class="reference internal" href="actions_generales.html">Actions générales</a></li>
<li class="toctree-l2"><a class="reference internal" href="modeles_de_formulaire.html">Modèles de formulaire</a></li>
<li class="toctree-l2"><a class="reference internal" href="parametres_utilisateur.html">Paramètres utilisateurs</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Installation et gestion de l’extension PostgreSQL <em>PlumePg</em></a><ul>
<li class="toctree-l3"><a class="reference internal" href="#compatibilite">Compatibilité</a></li>
<li class="toctree-l3"><a class="reference internal" href="#installation">Installation</a></li>
<li class="toctree-l3"><a class="reference internal" href="#localisation-des-objets-de-l-extension">Localisation des objets de l’extension</a></li>
<li class="toctree-l3"><a class="reference internal" href="#cohabitation-avec-asgard">Cohabitation avec <em>Asgard</em></a></li>
<li class="toctree-l3"><a class="reference internal" href="#mise-a-jour">Mise à jour</a></li>
<li class="toctree-l3"><a class="reference internal" href="#desinstallation">Désinstallation</a></li>
<li class="toctree-l3"><a class="reference internal" href="#sauvegarde-et-restauration-de-la-base">Sauvegarde et restauration de la base</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="metadonnees_communes.html">Métadonnées communes</a></li>
<li class="toctree-l2"><a class="reference internal" href="conformite_geodcat_ap.html">Conformité au profil GeoDCAT-AP</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../reference/modules.html">Référence</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mechanism/mechanism.html">Usage</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Plume</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="usage.html">Usage</a> &raquo;</li>
      <li>Installation et gestion de l’extension PostgreSQL <em>PlumePg</em></li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/usage/gestion_plume_pg.md.txt" rel="nofollow"> Afficher la source de la page</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="installation-et-gestion-de-l-extension-postgresql-plumepg">
<h1>Installation et gestion de l’extension PostgreSQL <em>PlumePg</em><a class="headerlink" href="#installation-et-gestion-de-l-extension-postgresql-plumepg" title="Lien permanent vers ce titre"></a></h1>
<p>L’extension PostgreSQL <em>PlumePg</em> est un composant optionnel de Plume, qui ouvre la possibilité d’utiliser des <span class="xref myst">modèles de formulaire</span>.</p>
<section id="compatibilite">
<h2>Compatibilité<a class="headerlink" href="#compatibilite" title="Lien permanent vers ce titre"></a></h2>
<table class="colwidths-auto docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Version</p></th>
<th class="head"><p>Compatibilité</p></th>
<th class="head"><p>Remarques</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>PostgreSQL 9.5</p></td>
<td><p>à évaluer</p></td>
<td><p>nécessite l’extension <code class="docutils literal notranslate"><span class="pre">pgcrypto</span></code></p></td>
</tr>
<tr class="row-odd"><td><p>PostgreSQL 10</p></td>
<td><p>oui</p></td>
<td><p>nécessite l’extension <code class="docutils literal notranslate"><span class="pre">pgcrypto</span></code></p></td>
</tr>
<tr class="row-even"><td><p>PostgreSQL 11</p></td>
<td><p>à évaluer</p></td>
<td><p>nécessite l’extension <code class="docutils literal notranslate"><span class="pre">pgcrypto</span></code></p></td>
</tr>
<tr class="row-odd"><td><p>PostgreSQL 12</p></td>
<td><p>à évaluer</p></td>
<td><p>nécessite l’extension <code class="docutils literal notranslate"><span class="pre">pgcrypto</span></code></p></td>
</tr>
<tr class="row-even"><td><p>PostgreSQL 13</p></td>
<td><p>à évaluer</p></td>
<td><p></p></td>
</tr>
<tr class="row-odd"><td><p>PostgreSQL 14</p></td>
<td><p>à évaluer</p></td>
<td><p></p></td>
</tr>
</tbody>
</table>
</section>
<section id="installation">
<h2>Installation<a class="headerlink" href="#installation" title="Lien permanent vers ce titre"></a></h2>
<p>Les fichiers d’installation de <em>PlumePg</em> se trouvent dans le dossier <span class="xref myst"><code class="docutils literal notranslate"><span class="pre">postgresql</span></code></span> du Git :</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">plume_pg--x.x.x.sql</span></code> contient le code de la version <code class="docutils literal notranslate"><span class="pre">x.x.x</span></code> de l’extension <em>PlumePg</em>. Celui-ci s’exécute lorsqu’elle est installée sur une base.</p></li>
<li><p><span class="xref myst"><code class="docutils literal notranslate"><span class="pre">plume_pg.control</span></code></span> contient quelques métadonnées et des informations de paramétrage.</p></li>
</ul>
<p>Ces deux fichiers doivent être copiés dans le répertoire des extensions du serveur. Son chemin varie selon l’environnement d’installation, mais il est vraisemblable qu’il soit de la forme <code class="docutils literal notranslate"><span class="pre">C:\Program</span> <span class="pre">Files\PostgreSQL\xx\share\extension</span></code> sous Windows et <code class="docutils literal notranslate"><span class="pre">/usr/share/postgresql/xx/extension</span></code> sous Linux, <code class="docutils literal notranslate"><span class="pre">xx</span></code> étant la version de PostgreSQL.</p>
<p>L’activation de <em>PlumePg</em> sur une base passe par une simple commande <code class="docutils literal notranslate"><span class="pre">CREATE</span> <span class="pre">EXTENSION</span></code>. Pour PostgreSQL 12 et les versions antérieures, il est toutefois nécessaire d’installer préalablement l’extension <a class="reference external" href="https://www.postgresql.org/docs/12/pgcrypto.html"><code class="docutils literal notranslate"><span class="pre">pgcrypto</span></code></a>, sur laquelle <em>PlumePg</em> s’appuie pour la génération des UUID<a class="footnote-reference brackets" href="#pgcrypto" id="id1">1</a>. Il s’agit d’une extension standard de PostgreSQL, qui est en principe disponible dans toutes les distributions des versions de PostgreSQL compatibles avec <em>PlumePg</em>.</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">CREATE</span><span class="w"> </span><span class="n">EXTENSION</span><span class="w"> </span><span class="k">IF</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">EXISTS</span><span class="w"> </span><span class="n">pgcrypto</span><span class="w"> </span><span class="p">;</span><span class="w"></span>
<span class="k">CREATE</span><span class="w"> </span><span class="n">EXTENSION</span><span class="w"> </span><span class="n">plume_pg</span><span class="w"> </span><span class="p">;</span><span class="w"></span>
</pre></div>
</div>
<p>Une autre possibilité est d’exécuter la commande <code class="docutils literal notranslate"><span class="pre">CREATE</span> <span class="pre">EXTENSION</span></code> avec l’option <code class="docutils literal notranslate"><span class="pre">CASCADE</span></code>, ce qui installe automatiquement toutes les extensions marquées comme requises dans <code class="docutils literal notranslate"><span class="pre">plume_pg.control</span></code> :</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">CREATE</span><span class="w"> </span><span class="n">EXTENSION</span><span class="w"> </span><span class="n">plume_pg</span><span class="w"> </span><span class="k">CASCADE</span><span class="w"> </span><span class="p">;</span><span class="w"></span>
</pre></div>
</div>
<p>L’installation est à réaliser par l’ADL. Il n’était pas pertinent que celle-ci puisse se faire via l’interface QGIS de Plume, dont la grande majorité des utilisateurs ne disposera pas des droits nécessaires sur le serveur PostgreSQL. Par contre, <a class="reference external" href="https://snum.scenari-community.org/Asgard/Documentation/#SEC_AsgardManager"><em>AsgardManager</em></a> propose cette fonctionnalité, via son menu <a class="reference external" href="https://snum.scenari-community.org/Asgard/Documentation/#SEC_MenuGestionBase"><code class="docutils literal notranslate"><span class="pre">Gestion</span> <span class="pre">de</span> <span class="pre">la</span> <span class="pre">base</span></code></a>.</p>
</section>
<section id="localisation-des-objets-de-l-extension">
<h2>Localisation des objets de l’extension<a class="headerlink" href="#localisation-des-objets-de-l-extension" title="Lien permanent vers ce titre"></a></h2>
<p>Tous les objets de l’extension sont créés dans le schéma <code class="docutils literal notranslate"><span class="pre">z_plume</span></code>.</p>
</section>
<section id="cohabitation-avec-asgard">
<h2>Cohabitation avec <em>Asgard</em><a class="headerlink" href="#cohabitation-avec-asgard" title="Lien permanent vers ce titre"></a></h2>
<p>Il n’y a pas de lien fonctionnel direct entre <em>PlumePg</em> et l’extension <a class="reference external" href="https://snum.scenari-community.org/Asgard/Documentation/"><em>Asgard</em></a>, outil créé dans le cadre du GT PostGIS pour faciliter la gestion des droits.</p>
<p>Si l’extension <em>PlumePg</em> est installée sur une base disposant déjà d”<em>Asgard</em>, <code class="docutils literal notranslate"><span class="pre">g_admin</span></code> sera automatiquement désigné comme <em>producteur</em> du schéma et <code class="docutils literal notranslate"><span class="pre">g_consult</span></code> en sera fait <em>lecteur</em>. Il s’agit juste de faciliter le travail de l’administrateur, cette opération ne crée aucune adhérence durable. Il est ensuite tout à fait possible, sans que cela ne pose de problème particulier, y compris lors des futures montées de version de <em>PlumePg</em> :</p>
<ul class="simple">
<li><p>de choisir d’autres rôles comme <em>producteur</em>, <em>éditeur</em> et <em>lecteur</em> de <code class="docutils literal notranslate"><span class="pre">z_plume</span></code> ;</p></li>
<li><p>de déréférencer le schéma <code class="docutils literal notranslate"><span class="pre">z_plume</span></code> pour gérer ses droits hors d”<em>Asgard</em> ;</p></li>
<li><p>de désinstaller <em>Asgard</em>.</p></li>
</ul>
<p><em>NB. Pour que l’affectation automatique de droits sur <code class="docutils literal notranslate"><span class="pre">z_plume</span></code> ait lieu, il faudra utiliser une version d’Asgard supérieure ou égale à la 1.3.2. Dans les versions antérieures, les schémas créés par les extensions n’étaient pas automatiquement référencés.</em></p>
</section>
<section id="mise-a-jour">
<h2>Mise à jour<a class="headerlink" href="#mise-a-jour" title="Lien permanent vers ce titre"></a></h2>
<p>Comme pour l’installation, les fichiers de mise à jour sont disponibles dans le dossier <span class="xref myst"><code class="docutils literal notranslate"><span class="pre">postgresql</span></code></span> du Git :</p>
<ul class="simple">
<li><p>un ou plusieurs fichiers <code class="docutils literal notranslate"><span class="pre">plume_pg--x.x.x--y.y.y.sql</span></code>, qui sont des scripts de passage de la version <code class="docutils literal notranslate"><span class="pre">x.x.x</span></code> à la version <code class="docutils literal notranslate"><span class="pre">y.y.y</span></code>. Plusieurs de ces scripts peuvent s’exécuter à la suite lors d’une mise à jour (<code class="docutils literal notranslate"><span class="pre">plume_pg--x.x.x--x1.x1.x1.sql</span></code>, <code class="docutils literal notranslate"><span class="pre">plume_pg--x1.x1.x1--x2.x2.x2.sql</span></code>, …, <code class="docutils literal notranslate"><span class="pre">plume_pg--xn.xn.xn--y.y.y.sql</span></code>).</p></li>
<li><p>un nouveau fichier <span class="xref myst"><code class="docutils literal notranslate"><span class="pre">plume_pg.control</span></code></span> remplaçant le précédent. Ce fichier change en principe peu d’une version à l’autre, si ce n’est pour la <em>version par défaut</em> qu’il spécifie, qui sera toujours la version la plus récente.</p></li>
<li><p>un fichier <code class="docutils literal notranslate"><span class="pre">plume_pg--y.y.y.sql</span></code> contenant le code complet de la version <code class="docutils literal notranslate"><span class="pre">y.y.y</span></code> de l’extension <em>PlumePg</em>. Celui-ci n’est pas utilisé lors de la mise à jour, mais pourra servir par la suite, notamment en cas de sauvegarde/restauration de la base, ou pour l’installation de <em>PlumePg</em> sur une nouvelle base.</p></li>
</ul>
<p>Cf. <span class="xref myst">Installation</span> pour l’emplacement du répertoire où ces fichiers doivent être copiés.</p>
<p>Sur toutes les bases où <em>PlumePg</em> était installée, on exécutera ensuite :</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">ALTER</span><span class="w"> </span><span class="n">EXTENSION</span><span class="w"> </span><span class="n">plume_pg</span><span class="w"> </span><span class="k">UPDATE</span><span class="w"> </span><span class="k">TO</span><span class="w"> </span><span class="s1">&#39;y.y.y&#39;</span><span class="w"> </span><span class="p">;</span><span class="w"></span>
</pre></div>
</div>
<p>Sauf à cibler une version qui ne serait pas la dernière, il est souvent plus simple de ne pas spécifier le numéro de version et d’effectuer la mise à jour sur la version par défaut définie par <code class="docutils literal notranslate"><span class="pre">plume_pg.control</span></code> :</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">ALTER</span><span class="w"> </span><span class="n">EXTENSION</span><span class="w"> </span><span class="n">plume_pg</span><span class="w"> </span><span class="k">UPDATE</span><span class="w"> </span><span class="p">;</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="desinstallation">
<h2>Désinstallation<a class="headerlink" href="#desinstallation" title="Lien permanent vers ce titre"></a></h2>
<p>Pour désinstaller <em>PlumePg</em> d’une base :</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">DROP</span><span class="w"> </span><span class="n">EXTENSION</span><span class="w"> </span><span class="n">plume_pg</span><span class="w"> </span><span class="p">;</span><span class="w"></span>
</pre></div>
</div>
<p>La désinstallation entraîne la perte définitive de tous les <span class="xref myst">modèles de formulaire</span>.</p>
<p><em>NB. Si le schéma <code class="docutils literal notranslate"><span class="pre">z_plume</span></code> existait avant l’installation de l’extension, il ne sera pas marqué comme dépendant de l’extension et ne sera donc pas supprimé en cas de désinstallation. Tout son contenu le sera, par contre.</em></p>
</section>
<section id="sauvegarde-et-restauration-de-la-base">
<h2>Sauvegarde et restauration de la base<a class="headerlink" href="#sauvegarde-et-restauration-de-la-base" title="Lien permanent vers ce titre"></a></h2>
<p>Pour que les données de <em>PlumePg</em> soient préservées lors de la restauration, notamment les <span class="xref myst">modèles de formulaire</span>, il est essentiel de <strong>ne pas chercher à réinstaller manuellement l’extension sur la base de restauration</strong>. Tout est automatique. On veillera seulement à ce que :</p>
<ul class="simple">
<li><p>les fichiers d’installation de <em>PlumePg</em> soient disponibles dans le répertoire des extensions du serveur de restauration (cf. <span class="xref myst">Installation</span> pour l’emplacement de ce répertoire) ;</p></li>
<li><p>la version par défaut de <em>PlumePg</em> sur le serveur de restauration soit identique à celle qui est effectivement installée sur la base à sauvegarder.</p></li>
</ul>
<p>Cette <em>version par défaut</em> apparaît dans le fichier <code class="docutils literal notranslate"><span class="pre">plume_pg.control</span></code> et peut également être consultée avec la requête (à exécuter sur n’importe quelle base du serveur de restauration) :</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">default_version</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">pg_available_extensions</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;plume_pg&#39;</span><span class="w"> </span><span class="p">;</span><span class="w"></span>
</pre></div>
</div>
<p>Pour connaître la version installée sur la base à sauvergarder, on pourra par exemple exécuter sur celle-ci :</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">installed_version</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">pg_available_extensions</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;plume_pg&#39;</span><span class="w"> </span><span class="p">;</span><span class="w"></span>
</pre></div>
</div>
<p>De manière très classique, le processus de restauration est le suivant :</p>
<ol class="arabic simple">
<li><p>Sauvegarder la base originale, par la méthode habituelle.</p></li>
<li><p>Créer une base vierge.</p></li>
<li><p>Lancer la restauration sur cette base vierge, par la méthode habituelle.</p></li>
</ol>
<hr class="footnotes docutils" />
<dl class="footnote brackets">
<dt class="label" id="pgcrypto"><span class="brackets"><a class="fn-backref" href="#id1">1</a></span></dt>
<dd><p><em>PlumePg</em> la fonction <code class="docutils literal notranslate"><span class="pre">gen_random_uuid()</span></code> pour générer des UUID. Pour les versions 10, 11, et 12 de PostgreSQL, elle est fournie par l’extension <em>pgcrypto</em>. Pour les versions 13 et supérieures, cette fonction est incluse dans le coeur de PostgreSQL (cf. <a class="reference external" href="https://www.postgresql.org/docs/13/functions-uuid.html">documentation de PostgreSQL</a>), installer <code class="docutils literal notranslate"><span class="pre">pgcrypto</span></code> n’est donc en principe plus nécessaire et il pourrait être pertinent de modifier le fichier <code class="docutils literal notranslate"><span class="pre">plume_pg.control</span></code> pour retirer <code class="docutils literal notranslate"><span class="pre">pgcrypto</span></code> de la liste des extensions requises.</p>
</dd>
</dl>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Pied de page">
        <a href="parametres_utilisateur.html" class="btn btn-neutral float-left" title="Paramètres utilisateurs" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Précédent</a>
        <a href="metadonnees_communes.html" class="btn btn-neutral float-right" title="Métadonnées communes" accesskey="n" rel="next">Suivant <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, République française.</p>
  </div>

  Compilé avec <a href="https://www.sphinx-doc.org/">Sphinx</a> en utilisant un
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">thème</a>
    fourni par <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>